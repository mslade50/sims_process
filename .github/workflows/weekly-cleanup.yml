name: Weekly Data Cleanup

# Runs every Sunday at midnight UTC (7pm EST Saturday / 8pm EDT Saturday)
on:
  schedule:
    - cron: '0 0 * * 0'  # Every Sunday at 00:00 UTC
  
  # Also allow manual trigger for testing
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Run cleanup script
      run: |
        # Create backup of any files we're about to delete (just in case)
        mkdir -p cleanup_backup
        
        echo "ğŸ—‘ï¸  Starting weekly data cleanup..."
        echo "================================================"
        
        # Count files before cleanup
        csv_count=$(find . -maxdepth 1 -name "*.csv" ! -path "./permanent_data/*" | wc -l)
        xlsx_count=$(find . -maxdepth 1 -name "*.xlsx" | wc -l)
        txt_count=$(find . -maxdepth 1 -name "*.txt" | wc -l)
        
        echo "ğŸ“Š Files to clean:"
        echo "  - CSV files in root: $csv_count"
        echo "  - Excel files in root: $xlsx_count"  
        echo "  - Text files in root: $txt_count"
        echo ""
        
        # List files that will be deleted (for logging)
        echo "ğŸ“‹ CSV files to be removed:"
        find . -maxdepth 1 -name "*.csv" ! -path "./permanent_data/*" -type f
        echo ""
        
        echo "ğŸ“‹ Excel files to be removed:"
        find . -maxdepth 1 -name "*.xlsx" -type f
        echo ""
        
        echo "ğŸ“‹ Tournament folders to be removed:"
        find . -maxdepth 1 -type d ! -name "." ! -name ".." ! -name ".git" ! -name ".github" ! -name "permanent_data" ! -name "backups" ! -name ".claude" ! -name "__pycache__"
        echo ""
        
        # Delete CSV files (except in permanent_data folder)
        echo "ğŸ—‘ï¸  Deleting CSV files..."
        find . -maxdepth 1 -name "*.csv" ! -path "./permanent_data/*" -type f -delete
        
        # Delete Excel files
        echo "ğŸ—‘ï¸  Deleting Excel files..."
        find . -maxdepth 1 -name "*.xlsx" -type f -delete
        
        # Delete text files (scraped sportsbook data)
        echo "ğŸ—‘ï¸  Deleting text files..."
        find . -maxdepth 1 -name "*.txt" -type f -delete
        
        # Delete tournament folders (but preserve system folders)
        echo "ğŸ—‘ï¸  Deleting tournament folders..."
        find . -maxdepth 1 -type d \
          ! -name "." \
          ! -name ".." \
          ! -name ".git" \
          ! -name ".github" \
          ! -name "permanent_data" \
          ! -name "backups" \
          ! -name ".claude" \
          ! -name "__pycache__" \
          -exec rm -rf {} + 2>/dev/null || true
        
        echo ""
        echo "âœ… Cleanup complete!"
        echo "================================================"
        
        # Show what remains
        echo ""
        echo "ğŸ“ Remaining files in repo:"
        ls -lah
    
    - name: Summary
      run: |
        echo "================================================"
        echo "ğŸ¯ CLEANUP SUMMARY"
        echo "================================================"
        echo "âœ… Deleted all CSV files (except permanent_data/)"
        echo "âœ… Deleted all Excel workbooks"
        echo "âœ… Deleted all text files"
        echo "âœ… Deleted all tournament folders"
        echo ""
        echo "ğŸ“ Protected folders:"
        echo "  - permanent_data/ (correlation matrices, reference data)"
        echo "  - backups/ (code backups)"
        echo "  - .github/ (workflows)"
        echo "  - .git/ (version control)"
        echo ""
        echo "ğŸ’¡ Tip: Historical data should now be in Google Drive"
        echo "================================================"
